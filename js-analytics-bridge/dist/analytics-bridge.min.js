!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).AnalyticsManager=e()}(this,function(){"use strict";class t{constructor(){if(t.instance)return t.instance;this._isInitialized=!1,this._gameId="",this._sessionName="",this._sessionId="",this._reportData={gameId:"",sessionId:"",timestamp:"",name:"",xpEarnedTotal:0,xpEarned:0,xpTotal:0,bestXp:0,lastPlayedLevel:"",highestLevelPlayed:"",perLevelAnalytics:{},rawData:[],diagnostics:{levels:[]}},t.instance=this}static getInstance(){return t.instance||(t.instance=new t),t.instance}initialize(t,e){this._gameId=t,this._sessionName=e,this._sessionId=e,this._reportData.gameId=t,this._reportData.sessionId=e,this._reportData.name=e,this._reportData.diagnostics.levels=[],this._reportData.rawData=[],this._reportData.perLevelAnalytics={},this._reportData.xpEarnedTotal=0,this._reportData.xpEarned=0,this._reportData.xpTotal=0,this._reportData.bestXp=0,this._reportData.lastPlayedLevel="",this._reportData.highestLevelPlayed="",this._isInitialized=!0,console.log(`[Analytics] Initialized for: ${t}`)}addRawMetric(t,e){this._isInitialized?this._reportData.rawData.push({key:t,value:String(e)}):console.warn("[Analytics] Not initialized")}startLevel(t){if(!this._isInitialized)return void console.warn("[Analytics] Not initialized");const e={levelId:t,successful:!1,timeTaken:0,timeDirection:!1,xpEarned:0,tasks:[]};this._reportData.diagnostics.levels.push(e)}endLevel(t,e,a,s){const i=this._getLevelById(t);this._reportData.xpEarned=this._reportData.xpEarnedTotal,this._reportData.xpTotal=this._reportData.xpEarnedTotal,this._reportData.bestXp=this._reportData.xpEarnedTotal,this._reportData.lastPlayedLevel=t,this._updateHighestLevel(t),this._updatePerLevelAnalytics(t,e,a,s),i?(i.successful=e,i.timeTaken=a,i.xpEarned=s,this._reportData.xpEarnedTotal+=s):console.warn(`[Analytics] End Level called for unknown level: ${t}`)}recordTask(t,e,a,s,i,n,r){const o=this._getLevelById(t);if(o){const t={taskId:e,question:a,options:"[]",correctChoice:s,choiceMade:i,successful:s===i,timeTaken:n,xpEarned:r};o.tasks.push(t)}else console.warn(`[Analytics] Record Task called for unknown level: ${t}`)}submitReport(){if(!this._isInitialized)return void console.error("[Analytics] Attempted to submit without initialization.");const t=JSON.parse(JSON.stringify(this._reportData));if(t.timestamp=(new Date).toISOString(),"undefined"==typeof window)return t;const e="ignite_pending_sessions_jsplugin";function a(t){let e=!1;try{window.myJsAnalytics&&"function"==typeof window.myJsAnalytics.trackGameSession&&(window.myJsAnalytics.trackGameSession(t),e=!0)}catch(t){}try{window.ReactNativeWebView&&"function"==typeof window.ReactNativeWebView.postMessage&&(window.ReactNativeWebView.postMessage(JSON.stringify(t)),e=!0)}catch(t){}try{const a=window.__GodotAnalyticsParentOrigin||"*";window.parent.postMessage(t,a),e=!0}catch(t){}if(!e)try{console.log("Payload:"+JSON.stringify(t))}catch(t){}return e}function s(){try{const t=JSON.parse(localStorage.getItem(e)||"[]");if(!t||!t.length)return;t.forEach(function(t){a(t)}),localStorage.removeItem(e)}catch(t){}}a(t)||function(t){try{const a=JSON.parse(localStorage.getItem(e)||"[]");a.push(t),localStorage.setItem(e,JSON.stringify(a))}catch(t){}}(t);try{"undefined"!=typeof window&&(window.addEventListener&&window.addEventListener("online",s),window.addEventListener&&window.addEventListener("load",s),window.addEventListener&&window.addEventListener("message",function(t){try{const e="string"==typeof t.data?JSON.parse(t.data):t.data;e&&"ANALYTICS_CONFIG"===e.type&&e.parentOrigin&&(window.__GodotAnalyticsParentOrigin=e.parentOrigin)}catch(t){}}),setTimeout(s,2e3))}catch(t){}}getReportData(){return JSON.parse(JSON.stringify(this._reportData))}reset(){this._reportData.xpEarnedTotal=0,this._reportData.xpEarned=0,this._reportData.xpTotal=0,this._reportData.bestXp=0,this._reportData.rawData=[],this._reportData.diagnostics.levels=[],this._reportData.perLevelAnalytics={},this._reportData.lastPlayedLevel="",this._reportData.highestLevelPlayed="",console.log("[Analytics] Data reset")}_getLevelById(t){const e=this._reportData.diagnostics.levels;for(let a=e.length-1;a>=0;a--)if(e[a].levelId===t)return e[a];return null}_updatePerLevelAnalytics(t,e,a,s){this._reportData.perLevelAnalytics[t]||(this._reportData.perLevelAnalytics[t]={attempts:0,wins:0,losses:0,totalTimeMs:0,bestTimeMs:1/0,totalXp:0,averageTimeMs:0});const i=this._reportData.perLevelAnalytics[t];i.attempts+=1,e?(i.wins+=1,i.totalXp+=s,a<i.bestTimeMs&&(i.bestTimeMs=a)):i.losses+=1,i.totalTimeMs+=a,i.averageTimeMs=Math.round(i.totalTimeMs/i.attempts),i.bestTimeMs===1/0&&(i.bestTimeMs=0)}_updateHighestLevel(t){this._extractLevelNumber(t)>this._extractLevelNumber(this._reportData.highestLevelPlayed)&&(this._reportData.highestLevelPlayed=t)}_extractLevelNumber(t){if(!t)return 0;const e=t.match(/level_(\d+)$/);return e?parseInt(e[1],10):0}}return t});
